{% extends "base.html" %}

{% block title %}Chat - SPART{% endblock %}

{% block content %}
<style>
    h1 {
        text-align: center;
        color: burlywood;
        font-size: x-large;
    }

    p {
        text-align: center;
        color: burlywood;
        font-size: small;
    }

    h4 {
        text-align: center;
    }

    h5 {
        color: burlywood;
    }

    h6 {
        text-align: center;
    }

    /* Estilo do Formulário de Perguntas */
    .form-control {
        background-color: #3c3939;
        color: burlywood;
        border: 0.3px solid #bdcbc8;
    }

    .form-control::placeholder {
        color: rgba(226, 206, 92, 0.7);
    }

    #chat-container {
        margin: 20px auto;
        max-width: 1300px;
        padding: 45px;
        border-radius: 25px;
        background-color: #232323;
        color: burlywood;
        overflow: hidden;
        width: 100%;
    }

    /* Footer */
    footer {
        background-color: #1c1c1c;
        padding: 35px 0;
        text-align: center;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
        color: burlywood;
    }

    /* Body */
    body {
        padding-bottom: 60px;
        background-color: #121212;
    }

    .list-group-item {
        background-color: #3c3939;
        border: none;
    }

    .list-group-item a {
        color: burlywood;
    }

    .list-group-item a:hover {
        text-decoration: underline;
    }

    .button {
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        display: flex;
        align-items: center;
        margin: 0 10px;
    }

    .button i {
        margin-right: 5px;
    }

    .button.success {
        background-color: #0c1330;
        color: burlywood;
        border: 0.3px solid #fdfed7;
    }

    .button.success:hover {
        background-color: #73cab8;
        transform: translateY(-2px);
    }

    .button.danger {
        background-color: #dc3545;
        color: white;
    }

    .button.danger:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    .button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .response-card {
        border: 2px solid #ffd9a8;
        border-radius: 10px;
        padding: 20px;
        background-color: #1c1c1c;
        margin-bottom: 20px;
        overflow: hidden;
        width: 100%;
    }

    .image-wrapper {
        width: 50%;
        margin: 25px 0;
        text-align: center;
    }

    .image-wrapper img {
        max-width: 50%;
        height: auto;
        display: block;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .card {
            margin: 10px;
        }

        .card img {
            max-height: 200px;
        }
    }

    .image-gallery {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px; /* Ajuste do espaçamento */
        margin-top: 20px;
    }

    .image-gallery a {
        display: block;
    }

    .image-gallery img {
        max-width: 300px; /* Ajuste do tamanho das imagens */
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .image-gallery img:hover {
        transform: scale(1.05);
    }
</style>

<div class="card" id="chat-container">
    <h1>SPART <img src='/static/capacete.png' style="height: 37px; width: 40px;" /></h1>
    <h6>Seu Assistente Inteligente!!!</h6>
    <h4>Como posso lhe ajudar hoje?</h4>
    <br><br>

    <input type="text" id="question" class="form-control" placeholder="Escreva aqui a sua dúvida!">
    <div class="button-container mt-4">
        <button class="button success" onclick="sendQuestion()">
            <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="button danger" id="stopBtn" onclick="stopTyping()" disabled>
            <i class="fas fa-stop"></i> Parar
        </button>
        <button class="button success" onclick="readResponse()">
            <i class="fas fa-volume-up"></i> Ouvir Resposta
        </button>
    </div>
    <br>
    <div class="container">
        <div class="response-card">
            <div id="response" class="mt-3"></div>
            <img src='/static/capacete.png' style="height: 20px; width: 22px;" />
            <span id="response-text"></span>
            {{ manual.conteudo|safe }}
            <div class="container-fluid">
                {% if manual.imagem %}
                <div class="image-wrapper">
                    <img src="{{ manual.imagem.url }}" alt="Imagem do Manual">
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        let fullResponse = "";
        let typingInterval;
        let isTyping = false;
        let synth = window.speechSynthesis;

        async function sendQuestion() {
            const question = document.getElementById("question").value;
            document.getElementById("response").innerHTML = "<span>Carregando...</span>";
            document.getElementById("stopBtn").disabled = true;

            try {
                const response = await fetch(`/chat/perguntar/?pergunta=${encodeURIComponent(question)}`);
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor');
                }
                const data = await response.json();
                fullResponse = data.resposta || "Desculpe, não consegui responder.";
                typeResponseWithEffect(fullResponse, data.imagens);
            } catch (error) {
                document.getElementById("response").innerText = "Erro ao enviar a pergunta: " + error.message;
            }
        }

        function typeResponseWithEffect(response, images) {
            const responseDiv = document.getElementById("response");
            responseDiv.innerHTML = "";
            let index = 0;
            isTyping = true;

            typingInterval = setInterval(() => {
                if (index < response.length) {
                    const char = response.charAt(index);
                    responseDiv.innerHTML += char === '\n' ? "<br>" : char;
                    index++;
                } else {
                    finalizeTyping(response, images);
                }
            }, 3);

            document.getElementById("stopBtn").disabled = false;
        }

        function finalizeTyping(response, images) {
            clearInterval(typingInterval);
            isTyping = false;
            document.getElementById("stopBtn").disabled = true;
            applyFullFormatting(response, images);
        }

        function applyFullFormatting(response, images) {
            const responseDiv = document.getElementById("response");
            responseDiv.innerHTML = response;
        
            if (images && images.length > 0) {
                const gallery = document.createElement('div');
                gallery.className = "image-gallery";
        
                images.forEach((image, index) => {
                    const linkElement = document.createElement('a');
                    linkElement.href = "#";
        
                    const imgElement = document.createElement('img');
                    imgElement.src = image;
                    imgElement.alt = "Imagem " + (index + 1);
        
                    linkElement.appendChild(imgElement);
                    gallery.appendChild(linkElement);
                });
        
                responseDiv.appendChild(gallery);
            }
        }

        function stopTyping() {
            if (isTyping) {
                clearInterval(typingInterval);
                document.getElementById("response").innerHTML = fullResponse;
                isTyping = false;
            }
        }

        function readResponse() {
            if (synth.speaking) {
                synth.cancel();
            } else {
                const utterance = new SpeechSynthesisUtterance(fullResponse);
                synth.speak(utterance);
            }
        }
    </script>

    <footer>
        <div id="footer-content">
            <h5>Sugestões de Perguntas:</h5>
            <ul class="list-group">
                {% for sugestao in sugerir_perguntas %}
                <li class="list-group-item">
                    <a href="#" onclick="document.getElementById('pergunta').value='{{ sugestao }}'; enviarPergunta();">
                        {{ sugestao }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </footer>
    {% endblock %}