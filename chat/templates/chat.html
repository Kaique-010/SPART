{% extends "base.html" %}

{% block title %}Chat - SPART{% endblock %}

{% block content %}
<style>
    h1 {
        text-align: center;
        color: burlywood;
        font-size: x-large;
    }

    p {
        text-align: center;
        color: burlywood;
        font-size: small;
    }

    h4 {
        text-align: center;
    }

    h5 {
        color: burlywood;
    }

    h6 {
        text-align: center;
    }

    /* Form de Perguntas */
    .form-control {
        background-color: #3c3939;
        color: burlywood;
        border: 0.3px solid #bdcbc8;
    }

    .form-control::placeholder {
        color: rgba(226, 206, 92, 0.7);
    }

    #chat-card {
        margin: 20px auto;
        max-width: 1300px;
        padding: 45px;
        border-radius: 25px;
        background-color: #232323;
        color: burlywood;
    }

    /* Footer */
    footer {
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #1c1c1c;
        padding: 35px 0;
        text-align: center;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
        color: burlywood;
    }

    /* Body */
    body {
        padding-bottom: 60px;
        background-color: #121212;
    }

    .list-group-item {
        background-color: #3c3939;
        border: none;
    }

    .list-group-item a {
        color: burlywood;
    }

    .list-group-item a:hover {
        text-decoration: underline;
    }

    .custom-btn {
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        display: flex;
        align-items: center;
        margin: 0 10px;
    }

    .custom-btn i {
        margin-right: 5px;
    }

    .custom-btn.success {
        background-color: #0c1330;
        color: burlywood;
        border: 0.3px solid #fdfed7;
    }

    .custom-btn.success:hover {
        background-color: #73cab8;
        transform: translateY(-2px);
    }

    .custom-btn.danger {
        background-color: #dc3545;
        color: white;
    }

    .custom-btn.danger:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    .custom-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .card-resposta {
        border: 2px solid #ffd9a8;
        border-radius: 10px;
        padding: 15px;
        background-color: #1c1c1c;
    }

    .imagem-wrapper {
        width: 100% !important;
        margin: 25px 0 !important;
        text-align: center !important;
    }

    .imagem-wrapper img {
        max-width: 100% !important;
        height: auto !important;
        text-align: center;
    }
</style>

<div class="card" id="chat-card">
    <h1>SPART <img src='/static/capacete.png' style="height: 37px; width: 40px;" /></h1>
    <h6>Seu Assistente Inteligente!!!</h6>
    <h4>Como Posso lhe ajudar hoje?</h4>
    <br><br>

    <input type="text" id="pergunta" class="form-control" placeholder="Escreva Aqui a Sua Dúvida!">
    <div class="mt-4 button-container">
        <button class="custom-btn success" onclick="enviarPergunta()">
            <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="custom-btn danger" id="pararBtn" onclick="pararEscrita()" disabled>
            <i class="fas fa-stop"></i> Parar
        </button>
        <button class="custom-btn success" onclick="lerTexto()">
            <i class="fas fa-volume-up"></i> Ouvir Resposta
        </button>
    </div>
    <br>

    <div class="card-resposta">
        <div id="resposta" class="mt-3"></div>
        <img src='/static/capacete.png' style="height: 20px; width: 22px;" />
        <span id="resposta-texto"></span>
        {{ manual.conteudo|safe }}
        {% if manual.imagem %}
        <img src="{{ manual.imagem.url }}" alt="Imagem do Manual" style="max-width: 100%; height: auto;">
        {% endif %}
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<script>
    let respostaCompleta = "";
    let typingInterval;
    let isTyping = false;  // Controle para efeito de digitação
    let synth = window.speechSynthesis;

    async function enviarPergunta() {
        const pergunta = document.getElementById("pergunta").value;
        document.getElementById("resposta").innerHTML = "<span>Carregando...</span>";
        document.getElementById("pararBtn").disabled = true;

        try {
            const response = await fetch(`/chat/perguntar/?pergunta=${encodeURIComponent(pergunta)}`);
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor');
            }
            const data = await response.json();
            respostaCompleta = data.resposta || "Desculpe, não consegui responder.";

            escreverRespostaComEfeito(respostaCompleta, data.imagens);
        } catch (error) {
            document.getElementById("resposta").innerText = "Erro ao enviar a pergunta: " + error.message;
        }
    }

    function escreverRespostaComEfeito(resposta, imagens, links) {
        const respostaDiv = document.getElementById("resposta");
        respostaDiv.innerHTML = ""; // Limpa a resposta anterior
        let index = 0;
        isTyping = true;

        typingInterval = setInterval(() => {
            if (index < resposta.length) {
                const char = resposta.charAt(index);
                respostaDiv.innerHTML += char === '\n' ? "<br>" : char;
                index++;
            } else {
                finalizarDigitacao(resposta, imagens, links); // Passa também os links
            }
        }, 3); // Velocidade da digitação

        document.getElementById("pararBtn").disabled = false;
    }

    function finalizarDigitacao(resposta, imagens, links) {
        clearInterval(typingInterval);
        isTyping = false;
        document.getElementById("pararBtn").disabled = true;
        aplicarFormatacaoCompleta(resposta, imagens, links);
    }

    function aplicarFormatacaoCompleta(resposta, imagens, links) {
        const respostaDiv = document.getElementById("resposta");
        respostaDiv.innerHTML = resposta; // Insere o HTML completo

        if (imagens && imagens.length > 0) {
            const galeria = document.createElement('div');
            galeria.className = "image-gallery"; // Classe para layout das imagens

            imagens.forEach((imagem, index) => {
                const linkElement = document.createElement('a');
                linkElement.href = "#"; // Não abre em nova aba
                linkElement.style.margin = "5px"; // Estilo opcional

                const imgElement = document.createElement('img');
                imgElement.src = imagem;
                imgElement.alt = "Imagem " + (index + 1);
                imgElement.style.maxWidth = "100%"; // Ajusta largura
                imgElement.style.height = "auto"; // Mantém proporção

                linkElement.appendChild(imgElement);
                galeria.appendChild(linkElement);
            });

            respostaDiv.appendChild(galeria); // Adiciona galeria de imagens
        }
    }


    function pararEscrita() {
        if (isTyping) {
            clearInterval(typingInterval);
            document.getElementById("resposta").innerHTML = respostaCompleta; // Exibe resposta completa
            isTyping = false;
        }
    }

    function lerTexto() {
        if (synth.speaking) {
            synth.cancel(); // Para a leitura atual
        } else {
            const utterance = new SpeechSynthesisUtterance(respostaCompleta);
            synth.speak(utterance); // Inicia a leitura da resposta
        }
    }
</script>

<footer>
    <div id="footer-content">
        <h5>Sugestões de Perguntas:</h5>
        <ul class="list-group">
            {% for sugestao in sugerir_perguntas %}
            <li class="list-group-item">
                <a href="#" onclick="document.getElementById('pergunta').value='{{ sugestao }}'; enviarPergunta();">
                    {{ sugestao }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</footer>
{% endblock %}